pipeline {
    agent {
        docker {
            image 'mcr.microsoft.com/dotnet/sdk:10.0' 
            args '-v /var/run/docker.sock:/var/run/docker.sock -v /usr/bin/docker:/usr/bin/docker -u root'
        }
    }
	
	environment{
		DOTNET_ENVIRONMENT = 'Development'
		IMAGE_NAME = "matejanikolikj/nba-fantasy-app"
		IMAGE_TAG = "${env.BUILD_NUMBER}"
		DOCKER_HUB_CREDENTIALS = 'docker-hub-credentials'
		GITHUB_CONTEXT = "Jenkins CI Build"
	}

    stages {
		
		stage('Test Repository'){
            steps{
				githubNotify(
					account: 'mateja503',
					repo: 'NBAFantasy',
					credentialsId: 'cb1a22d0-0e56-4363-95f5-5376109acb94', // Use the ID from your logs
					sha: env.GIT_COMMIT,
					status: 'PENDING',
					context: env.GITHUB_CONTEXT,
					description: "Running Test...."
				)	
				sh 'dotnet restore' 
				sh 'dotnet build --configuration Release'
                sh 'echo "Tests passed"'
            }
        }

		stage('Generate Aspire Manifest') {
            steps {
				githubNotify(
						account: 'mateja503',
						repo: 'NBAFantasy',
						credentialsId: 'cb1a22d0-0e56-4363-95f5-5376109acb94', // Use the ID from your logs
						sha: env.GIT_COMMIT,
						status: 'PENDING',
						context: env.GITHUB_CONTEXT,
						description: "Generating Manifest...."
					)	
				sh 'dotnet run --project NBAFantasy/NBAFantasy.csproj --publisher manifest --output-path manifest.json'
            }
        }

        stage('Build Image') {
            steps {
				githubNotify(
							account: 'mateja503',
							repo: 'NBAFantasy',
							credentialsId: 'cb1a22d0-0e56-4363-95f5-5376109acb94', // Use the ID from your logs
							sha: env.GIT_COMMIT,
							status: 'PENDING',
							context: env.GITHUB_CONTEXT,
							description: "Buliding Image...."
						)	
			
					sh """	
							apt-get update && apt-get install -y docker.io
							dotnet publish NBA.Api/NBA.Api.csproj \
							/t:PublishContainer \
							-p:ContainerRepository=${IMAGE_NAME} \
							-p:ContainerImageTag=latest \
							-p:ContainerRuntimeIdentifier=linux-x64 \
							-p:PublishContainer=true \
							-c Release
						"""
				}
        }
		
		stage('Push Image'){
			steps {
				githubNotify(
								account: 'mateja503',
								repo: 'NBAFantasy',
								credentialsId: 'cb1a22d0-0e56-4363-95f5-5376109acb94', // Use the ID from your logs
								sha: env.GIT_COMMIT,
								status: 'PENDING',
								context: env.GITHUB_CONTEXT,
								description: "Pushing Image...."
							)	
					script { // This wrapper is mandatory
						docker.withRegistry('https://registry.hub.docker.com',"${DOCKER_HUB_CREDENTIALS}"){
							def image = docker.image("${IMAGE_NAME}")
							image.push("${IMAGE_TAG}")
							image.push("latest")
						}		
					}		
				}
		}
    }
	
	post{
		always{
			sh "docker rmi ${IMAGE_NAME}:${IMAGE_TAG} || true"
		}
        success {
			githubNotify(
					account: 'mateja503',
					repo: 'NBAFantasy',
					credentialsId: 'cb1a22d0-0e56-4363-95f5-5376109acb94', // Use the ID from your logs
					sha: env.GIT_COMMIT,
					status: 'SUCCESS',
					description: "Description-test-success"
				)			
        }
        failure {
			githubNotify(
					account: 'mateja503',
					repo: 'NBAFantasy',
					credentialsId: 'cb1a22d0-0e56-4363-95f5-5376109acb94', // Use the ID from your logs
					sha: env.GIT_COMMIT,
					status: 'FAILURE',
					description: "Description-test-failure"
				)	
        }
	}
}

