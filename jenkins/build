pipeline {
    agent {
        docker {
            image 'mcr.microsoft.com/dotnet/sdk:10.0' 
            // Reuse the host's docker socket so 'dotnet publish /t:PublishContainer' works
            args '-v /var/run/docker.sock:/var/run/docker.sock -u root'
            // Optional: prevents checking the registry if the image exists locally
            alwaysPull false 
        }
    }
	
	environment{
		DOTNET_ENVIRONMENT = 'Development'
		IMAGE_NAME = "matejanikolikj/nba-fantasy-app"
		IMAGE_TAG = "${env.BUILD_NUMBER}"
	}

    stages {
		
		stage('Test Repository'){
            steps{
				githubNotify(
					account: 'mateja503',
					repo: 'NBAFantasy',
					credentialsId: 'cb1a22d0-0e56-4363-95f5-5376109acb94', // Use the ID from your logs
					sha: env.GIT_COMMIT,
					status: 'PENDING',
					context: 'Test Repository',
					description: "Description-test-repository"
				)	
				sh 'dotnet restore' 
				sh 'dotnet build --configuration Release'
                sh 'echo "Tests passed"'
            }
        }

		stage('Generate Aspire Manifest') {
            steps {
                // This tells the AppHost to generate the manifest.json without running the app
                // Change 'AppHost.csproj' to your actual AppHost project name
				sh 'dotnet run --project NBAFantasy/NBAFantasy.csproj --publisher manifest --output-path manifest.json'
            }
        }

        stage('Build Image') {
            steps {
                // Build the image and tag it 'nba-fantasy'
                //sh 'docker build -t nba-fantasy-app:latest .'
				//app = docker.build("${IMAGE_NAME}")
				sh """
                    dotnet publish NBA.Api/NBA.Api.csproj \
                        /t:PublishContainer \
                        -p:ContainerImageName=${IMAGE_NAME} \
                        -p:ContainerImageTag=latest \
                        -c Release
                    """
				
            }
        }
		
		stage('Test Image'){
			steps{
				sh 'echo "Test Image"'
			}
		}

        stage('Push Image') {
            steps {
                script {
                  docker.withRegistry('https://registry.hub.docker.com','docker-hub-credentials'){
					docker.image("${IMAGE_NAME}:latest").push()
				  }
                }
            }
        }
    }
	
	post{
		always {
        // This removes the image from the Jenkins agent disk so it doesn't fill up
        // but it stays safe on Docker Hub!
			sh "docker rmi ${IMAGE_NAME}:latest || true"
		}
        success {
			githubNotify(
					account: 'mateja503',
					repo: 'NBAFantasy',
					credentialsId: 'cb1a22d0-0e56-4363-95f5-5376109acb94', // Use the ID from your logs
					sha: env.GIT_COMMIT,
					status: 'SUCCESS',
					description: "Description-test-success"
				)			
        }
        failure {
			githubNotify(
					account: 'mateja503',
					repo: 'NBAFantasy',
					credentialsId: 'cb1a22d0-0e56-4363-95f5-5376109acb94', // Use the ID from your logs
					sha: env.GIT_COMMIT,
					status: 'FAILURE',
					description: "Description-test-failure"
				)	
        }
	}
}

